# FatChrono

Монорепозиторий платформы хронометража велогонок.

## Структура
- `apps/backend`: сервис на NestJS для авторизации через Telegram, управления гонками и приёма отметок.
- `apps/web`: фронтенд на Next.js с админкой, экраном ручного хронометража и публичными результатами.
- `packages/shared`: общие TypeScript-модели, схемы валидации и утилиты (готово к наполнению в будущем).

## Как запустить локально
```bash
# установка зависимостей (из корня репозитория)
npm install --workspaces

# запуск бэкенда и фронтенда по отдельности
npm run dev:backend
npm run dev:web
```

## Запуск через Docker
```bash
docker compose up --build -d
```

Команда соберёт два контейнера (NestJS на порту `3001`, Next.js на порту `3000`) и запустит их в фоне. Горячая перезагрузка в контейнерах не включена — пересоберите образ после изменений.

### Переменные окружения

1. Скопируйте файл примера и подставьте реальные значения:
   ```bash
   cp .env.example .env
   ```
2. Укажите токен Telegram-бота и секрет для JWT:
   ```env
   TELEGRAM_BOT_TOKEN=
   JWT_SECRET=замените-на-надежный-строковый-секрет
   ```

Docker Compose автоматически подхватывает `.env` для бэкенда.

**Одной строкой обновить и запустить** (подтянуть свежие изменения, пересобрать, поднять сервисы):
```bash
git pull && docker compose up --build -d
```

Эндпоинт бэкенда: `http://localhost:3001/api`. Фронтенд доступен на `http://localhost:3000`.

## Ключевые возможности (план)
- Авторизация через Telegram с поддержкой ролей.
- Настройка гонок: количество кругов, категории, импорты участников.
- PWA для ручного хронометража с офлайн-очередью отметок.
- Живая таблица результатов на WebSocket/SSE.

## Ближайшие шаги
1. Подключить Prisma/PostgreSQL и описать схемы гонок, участников и кругов.
2. Реализовать авторизацию по Telegram (валидация hash, выпуск JWT).
3. Связать экран хронометража с WebSocket-бэкендом и сохранять отметки.
4. Построить агрегатор результатов и трансляцию обновлений в реальном времени.
5. Добавить импорт/экспорт CSV, инструменты аудита и исправления результатов.

## Контрибьюторам
Используйте Node.js 20+. Перед PR обязательно запускайте линтеры, тесты и форматирование.

## Авторизация через Telegram
- Создайте бота в @BotFather и вставьте токен в `.env` (`TELEGRAM_BOT_TOKEN`).
- Укажите юзернеймы администраторов (через запятую) в `TELEGRAM_ADMIN_IDS`.
- Передайте имя бота без `@` в `NEXT_PUBLIC_TELEGRAM_BOT_USERNAME` (используется на фронтенде).
- Страница входа доступна по `/login`. Успешный вход выдаёт JWT, который сохраняется в `localStorage`.
- Админ-панель `/admin` требует роль `admin` и защищена через Bearer-токен.

## Управление гонками
- В админке можно создавать гонки, переключать активную и управлять категориями.
- Добавленные или изменённые категории моментально передаются в хронометраж и результаты.
- Форма участников позволяет назначать стартовый номер, имя и категорию; список моментально обновляется.
- Все запросы выполняются через `/api/race/*` с авторизацией `Bearer <JWT>`.
# fatchrono
