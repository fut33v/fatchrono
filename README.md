# FatChrono

Монорепозиторий платформы хронометража велогонок.

## Структура
- `apps/backend`: сервис на NestJS для авторизации через Telegram, управления гонками и приёма отметок.
- `apps/web`: фронтенд на Next.js с админкой, экраном ручного хронометража и публичными результатами.
- `packages/shared`: общие TypeScript-модели, схемы валидации и утилиты (готово к наполнению в будущем).

## Как запустить локально
```bash
# установка зависимостей (из корня репозитория)
npm install --workspaces

# запустить PostgreSQL (подключена через docker-compose)
docker compose up db -d

# применить миграции и сгенерировать Prisma Client
npx prisma generate --schema prisma/schema.prisma
npx prisma migrate deploy --schema prisma/schema.prisma

# запуск бэкенда и фронтенда по отдельности
npm run dev:backend
npm run dev:web

# заполнить демо-данными (одна гонка на 40 участников)
node scripts/seed-demo.js
```

## Запуск через Docker
```bash
docker compose up --build -d
```

Команда соберёт два контейнера (NestJS на порту `3001`, Next.js на порту `3000`) и запустит их в фоне. Горячая перезагрузка в контейнерах не включена — пересоберите образ после изменений.

### Переменные окружения

1. Скопируйте файл примера и подставьте реальные значения:
   ```bash
   cp .env.example .env
   ```
2. Укажите токен Telegram-бота и секрет для JWT:
   ```env
   TELEGRAM_BOT_TOKEN=
   JWT_SECRET=замените-на-надежный-строковый-секрет
   ```

Docker Compose автоматически подхватывает `.env` для бэкенда. Если используете встроенную базу данных, оставьте `DATABASE_URL=postgresql://postgres:postgres@db:5432/fatchrono`.

**Одной строкой обновить и запустить** (подтянуть свежие изменения, пересобрать, поднять сервисы):
```bash
git pull && docker compose up --build -d
```

### Скрипт локальной разработки
```bash
./scripts/dev.sh
```
Скрипт автоматически загружает переменные из `.env`, поднимает контейнер с PostgreSQL, генерирует Prisma-клиент, применяет миграции и запускает `npm run dev:backend` и `npm run dev:web`. Остановить всё можно `Ctrl+C`.

Эндпоинт бэкенда: `http://localhost:3001/api`. Фронтенд доступен на `http://localhost:3000`.

## Ключевые возможности (план)
- Авторизация через Telegram с поддержкой ролей.
- Настройка гонок: количество кругов, категории, импорты участников.
- PWA для ручного хронометража с офлайн-очередью отметок.
- Живая таблица результатов на WebSocket/SSE.

## Ближайшие шаги
1. Добавить импорт/сидинг участников и категорий из CSV/Excel.
2. Расширить модель результатов (учёт финиша, штрафов, отставаний).
3. Усилить офлайн-синхронизацию хронометража и повторную отправку отметок.
4. Покрыть бэкенд интеграционными тестами и проверками миграций.
5. Подготовить публичные API-ключи для внешних табло и трансляций.

## Контрибьюторам
Используйте Node.js 20+. Перед PR обязательно запускайте линтеры, тесты и форматирование.

## Авторизация через Telegram
- Создайте бота в @BotFather и вставьте токен в `.env` (`TELEGRAM_BOT_TOKEN`).
- Укажите юзернеймы администраторов (через запятую) в `TELEGRAM_ADMIN_IDS`.
- Передайте имя бота без `@` в `NEXT_PUBLIC_TELEGRAM_BOT_USERNAME` (используется на фронтенде).
- Страница входа доступна по `/login`. Успешный вход выдаёт JWT, который сохраняется в `localStorage`.
- Админ-панель `/admin` требует роль `admin` и защищена через Bearer-токен.

## Управление гонками
- В админке можно создавать гонки, переключать активную и управлять категориями.
- Добавленные или изменённые категории моментально передаются в хронометраж и результаты.
- Форма участников позволяет назначать стартовый номер, имя и категорию; список моментально обновляется.
- Для каждой гонки генерируются прямые ссылки (`/results/{id}`, `/chrono/{id}`, `/leaderboard/{id}`), их можно копировать из админки и расшаривать.
- Все запросы выполняются через `/api/race/*` с авторизацией `Bearer <JWT>`.
# fatchrono
